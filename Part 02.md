# Gearbox Equations

## 1. Torque Equation

### Variable Definitions

#### Motor

* $\Large \tau_m$ : Torque generated by the motor. Measured in Newton-Meters: $\Large Nm$.
* $\Large I_m$ : Electrical current running through the motor. Measured in Amperes (Amps): $\Large A$
* $\Large K_t$ : Motor-torque constant. Measured in Newton-Meters per Amp: $\Large \frac{Nm}{A}$
* $\Large \tau_{s_{m}}$ : Torque due to static friction on the motor. Measured in Newton-Meters: $\Large Nm$.
* $\Large \tau_{s_{g}}$ : Torque due to the static friction on the gearbox. Measured in Newton-Meters: $\Large Nm$.
* $\Large \omega_{m}$ : Angular velocity of the motor. Measured in Radians per Second: $\Large \frac{rad}{s}$

#### Gearbox

* $\Large G$ : The gear ratio (reduction | gear ratio | gearing). The ratio of input (motor) rotations to output (
  gearbox) rotations. Unitless quantity. Values larger than 1 indicate that the gearbox output rotations are smaller
  than the motor input rotations.
* $\Large n$ : The number of identical motors in the gearbox. Unitless 01
* $\Large \tau_G$ : Torque generated by the gearbox. Measured in Newton-Meters: $\Large Nm$.
* $\Large \omega_G$ : Angular velocity of the gearbox's output shaft. Measured in Radians per
  Second: $\Large \frac{rad}{s}$

The relationship between the torque generated by the motor and the torque generated by the gearbox given $\Large n$ identical motors and a gear
reduction of $\Large G$ is:

> $\Large \tau_g = nG\tau_m$
>
> $\Large \tau_m = \frac{\tau_g}{nG}$

The relationship between the angular velocity of the motor and the angular velocity of the gearbox's output shaft is:

> $\Large \omega_g = \frac{\omega_m}{G}$
>
> $\Large \omega_m = G\omega_g$

Given the motor torque equation from Section 02 of Part 01. We can substitute in the above-mentioned toque and angular
velocity relationships to derive a torque equation for a gearbox.


> $\Large \tau_m = K_tI_m - \tau_{s_{m}} sgn(\omega_m)$
>
> $\Large \frac{\tau_g}{nG} = K_tI_m - \tau_{s_{g}}sgn(G\omega_g)$
>
> $\Large \frac{\tau_g}{nG} = K_tI_m - \tau_{s_{g}}Gsgn(\omega_g)$
>
> $\Large \tau_g = nGK_tI_m - \tau_{s_{g}}nG^2sgn(\omega_g)$

## 2. Angular Acceleration Equation

### Variable Definitions

* $\Large J$ : Total moment of inertia of the gearbox. Measured in Kilogram square meters: $\Large kgm^2$
* $\Large \alpha_g$ : Angular acceleration of the gearbox.

The net gearbox torque is a product of the moment of inertia of the gearbox and the gearbox's angular acceleration.

> $\Large \tau_g = J\alpha_g$

This can be used to solve for the angular acceleration of the gearbox in terms of current and angular velocity. 

> $\Large J\alpha_g = nGK_tI_m - \tau_{s_{g}}nG^2sgn(\omega_g)$
> 
> $\Large \alpha_g = \frac{nGK_t}{J}I_m - \frac{\tau_{s_{g}}nG^2}{J}sgn(\omega_g)$

## 3. System Characterization Model (SysId)

### Variable Definitions

* $\Large k_s$ : Static friction gain constant
* $\Large k_v$ : Velocity gain constant (Please note the difference between $\Large k_v$ and $\Large K_v$)
* $\Large k_a$ : Acceleration gain constant
* $\Large x$ : The state variable (angular position in our case)
* $\Large \dot{x}$: The rate of change of the $\Large x$ (angular velocity in our case)
* $\Large \ddot{x}$: The rate of change of $\Large \dot{x}$ (angular acceleration in our case)
* $\Large u$ : The input used to control the state (current or voltage)

WPILib provides a utility called SysId that will help with determining how best to control the state of the system.  
For the gearbox (Simple setting) the software assumes the following affine model.  

> $\Large u = k_ssgn(\dot{x}) + k_v\dot{x} + k_a\ddot{x}$

Solving for $\Large \ddot{x}$ gives us.

> $\Large k_a\ddot{x} = -k_v\dot{x} + u - k_ssgn(\dot{x})$
> 
> $\Large \ddot{x} = -\frac{k_v}{k_a} \dot{x} + \frac{1}{k_a}u - \frac{k_s}{k_a}sgn(\dot{x})$

## 4. Current Control Model

We can make the following substitutions in the SysId equation to evaluate the characterization constants.

> $\Large \dot{x} = \omega_g$, $\Large \ddot{x} = \alpha_g$, $\Large u = I_m$
> 
> $\Large \alpha_g = -\frac{k_v}{k_a} \omega + \frac{1}{k_a}I_m - \frac{k_s}{k_a}sgn(\omega)$

Since $\Large \alpha_g$ doesn't have an $\Large \omega_g$ term then 

> $\Large \frac{-k_v}{k_a} = 0$, $\Large k_v = 0$

Matching the $\Large I_m$ terms gives us.

> $\Large \frac{1}{k_a} = \frac{nGK_t}{J}$, $\Large k_a = \frac{J}{nGK_t}$

The torque due to static friction needs to be determined experimentally.  However $\Large k_s$ which is determined by SysId is related to the static friction torque as follows.

